name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  release-to-stage:
    if: contains(github.event.head_commit.message, 'release:')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          debug: true
          script: |
            set -e  # Stop on first error

            echo "ğŸ“ Moving to project directory"
            cd /home/ubuntu/marketpulse

            echo "ğŸ”„ Fetching latest code"
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ Activating virtualenv"
            source venv/bin/activate

            echo "ğŸ“¦ Installing requirements"
            pip install -r requirements.txt

            echo "ğŸ§¬ Running migrations"
            python manage.py migrate

            echo "ğŸ¨ Collecting static files"
            python manage.py collectstatic --noinput

            echo "ğŸš€ Restarting Gunicorn"
            sudo systemctl restart gunicorn

            echo "âš™ï¸ Restarting Celery Worker"
            sudo systemctl restart celery-worker

            echo "â° Restarting Celery Beat"
            sudo systemctl restart celery-beat

            echo "âœ… Deployment completed successfully!"

